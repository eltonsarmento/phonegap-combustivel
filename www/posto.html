
<!DOCTYPE html>
<html>
<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Panel styling - jQuery Mobile Demos</title>

    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <script src="js/verificaAcesso.js"></script>
    <link rel="stylesheet" href="css/paginaPosto.css" />

</head>
<body>

<div data-role="page" style="top: 0px" id="demo-page">
    <div role="main" class="ui-contents jqm-content jqm-fullwidth">     
        <div data-role="tabs">    
            <div data-role="navbar">
                <ul>
                    <li><a class="ui-btn-actives"  data-theme="b" data-ajax="false"></a></li>
                 </ul>
                 <ul>
                    <li><a class="ui-btn-actives"  data-theme="b" data-ajax="false"></a></li>
                 </ul>
            </div>
        </div>
    </div>
    <div class="ui-panel-wrappers">
        <div data-role="header">
            <h1 id="headerNomePosto">Posto</h1>
            <a href="home.html" data-ajax="false" data-position="right"  data-icon="back">Voltar</a>
        </div><!-- /header -->
    </div><!-- /header -->

    <div role="main" class="ui-content">

        <div class="article">
            <p><img id="imgBandeira" width="300px" heigh="50px" tsrc="http://demos.jquerymobile.com/1.4.5/_assets/img/bike.jpg" alt="Fixed Gear bike"></p>

            <!--  BOTÃO IR ATÉ O POSTO-->
            <center>
                 <div id="btnCalcularRota" class=" ui-btn ui-icon-location ui-btn-icon-notext ui-btn-b ui-corner-all ">
                    <a href="#" ></a>
                    <input type="hidden" id="latlonPosto"></input>
                 </div>
            </center>
            
            <input type="hidden" id="codigoPosto">
            
            <center ><h3><strong id="nome"></h3></strong></center>
            <center id="endereco"></center>
            <center><strong>Valores dos Combustíveis</strong></center>
            <center>
            <table data-role="tables" id="table-column-toggle" data-mode="columntoggle" class="ui-responsive table-strokes">
                 <thead>
                   <tr>
                     <th data-priority="3" >Gasolina</th>
                     <th data-priority="3" >Álcool</th>            
                     <th data-priority="3" >Diesel</th>            
                     <th data-priority="3" >GNV</th>
                   </tr>
                 </thead>
                 <tbody>
                   <tr>
                     <td><input type="text" id="inputGasolina" disabled="true"  value="0.00"></td>
                     <td><input type="text" id="inputAlcool" disabled="true" value="0.00"></td>
                     <td><input type="text" id="inputDiesel" disabled="true" value="0.00"></td>
                     <td><input type="text" id="inputGnv" disabled="true" value="0.00"></td>
                   </tr>            
                 </tbody>
            </table></center>

            
            <center><div id="estrelas" data-score="5"></div></center>
            

            <fieldset class="ui-grid-a">
                <div class="ui-block-a">
                    <a id="btnEditar" class="ui-btn ui-corner-all ui-shadow ui-minis" >$$ Editar</a>
                </div>
                <div class="ui-block-b">
                    <a id="btnFavoritar" class="ui-btn ui-corner-all ui-shadow ui-minis" >Favoritar</a>
                </div>
            </fieldset>
            

            <center >
                    <textarea style="display: none" id="textareaComentario" cols="5" rows="3" name="textarea-8" id="textarea-8" data-mini="true" placehold="escreva aqui..."></textarea>     
            </center>
            <a id="btnComentar" class="ui-btn ui-corner-all ui-shadow" >Comentar</a>

            <a href="comentarios.html" id="btnTodosComentarios" style="display: none" class="ui-btn ui-corner-all ui-shadow" data-ajax="false">Todos Comentários</a>

            <div class="item">                
                <input id="score-function" type="hidden" value="1" class="input">
                <a id="score-function-run" href="javascript:void(0);" title="score"></a>
            </div>
            <div class="item">
                <input id="readOnly-function" type="hidden" value="true" class="input">
                <a id="readOnly-function-run" href="javascript:void(0);" title="readOnly"></a>
            </div>

            <a href="#popupDialog" id="btnPopup" data-rel="popup" data-position-to="window" data-transition="pop" >x</a>
            <div data-role="popup" id="popupDialog" data-overlay-theme="b" data-theme="b" data-dismissible="false" style="max-width:400px;">
                <div data-role="header" data-theme="a"><h1 id="tituloPopup"></h1></div>
                <div role="main" class="ui-content">
                    <h3 class="ui-title" id="textoMaiorPopup"></h3>
                     <p id="textoMenorPopup"></p>
                    <a href="#" class="ui-btn ui-corner-all ui-shadow  ui-btn-b" data-rel="back" id="btnOkPopup">Entendi</a>
                </div>
            </div> 
            

             <a id="cancelarLoader" class="hide-page-loading-msg" ></a>

        <a id="loaderMap" data-msgtext="Traçando Rota..." data-theme="b"  class="show-page-loading-msg" data-textonly="false" data-textvisible="true" data-msgtext="" data-inline="true"></a>

    
        </div>

        </div><!-- /article -->

       
        
    </div><!-- /content -->   

</div><!-- /page -->

<!-- http://wbotelhos.com/raty -->
<!-- <script src="http://wbotelhos.com/raty/vendor/jquery.js"></script> -->
<script src="http://wbotelhos.com/raty/lib/jquery.raty.js"></script>
<script src="http://wbotelhos.com/assets/labs-f89db1876352706b8b1fcabfd4db23bf.js" type="text/javascript"></script>

<script>
/* CALCULAR ROTA*/
$('#btnCalcularRota').on('click',function(e){
    e.preventDefault();
    
    $("#loaderMap").click();    
    if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            var  lat = position.coords.latitude;
            var  lon = position.coords.longitude;
            var usuarioLocation = lat + "," + lon;
            var postoLocation   = $("#latlonPosto").val();
            var codigoPosto     = $("#codigoPosto").val();

            window.localStorage.setItem("userLocation", usuarioLocation);
            window.localStorage.setItem("postoLocation", postoLocation);
            window.localStorage.setItem("codigoPosto", codigoPosto);


            window.location.href = "mapa.html";
            $("#cancelarLoader").click();
            }, function() {      
        });
    } else {
        $("#cancelarLoader").click();
    }
});
/* EDITA COMBUSTÍVEIS*/
$('#btnEditar').on('click',function(e){
    e.preventDefault();
    if($(this).html() == 'Gravar'){
        gravarEdicao();
        $("input[type='text']").attr( "disabled", 'disabled' );
        $( ".ui-input-text" ).addClass("ui-state-disabled")    
        $(this).html('Editar');
    }else if ($(this).html() == '$$ Editar'){
        $("input[type='text']").prop( "disabled", false );
        $( ".ui-input-text" ).removeClass("ui-state-disabled")    
        $(this).html('Salvar valores');
    }
});
function gravarEdicao(){
    var gasolina = $('#inputGasolina').val();
    var alcool = $('#inputAlcool').val();
    var diesel = $('#inputDiesel').val();
    var gnv    = $('#inputGnv').val();
    var id_posto   = $('#codigoPosto').val();
    $.ajax({
        type: "POST",
        url: "http://eforms.esy.es/phonegap/editarCombustiveisPosto.php",
        //url: "http://localhost:8888/combustivel/www/php/editarCombustiveisPosto.php",
        data: {codigoPosto: id_posto,gasolina: gasolina, alcool: alcool, diesel: diesel, gnv: gnv},
        success: function (result) {
            if(result == '1'){
                alert('Combustíveis salvos com sucesso!');
            }else{          
                alert('não foi possivel comentar. '+result);                                  
            }
        },
        error: function () {
            alert('error kkk');
        }
    })
}
/* FIM EDITA COMBUSTÍVEIS*/

/* COMENTA POSTO*/
$('#btnComentar').on('click',function(e){
    e.preventDefault(); 
    if($(this).html() == "Comentar"){ 
        document.getElementById("textareaComentario").style.display = "block";        
        $(this).html('Enviar Comentario');
    }else if($(this).html() == "Enviar Comentario"){        
         resposta = gravaComentario($("#textareaComentario").val());
         document.getElementById("textareaComentario").style.display = "none";        
         document.getElementById("textareaComentario").html = "";
         $(this).html('Comentar');
         
    }
});
function gravaComentario(texto){
    var comentario = $('#textareaComentario').val();
    if(comentario == ''){
        alert('Comentário não pode estar vazio.');
    }else{

        var id_usuario = window.localStorage.getItem("codigo");;
        var id_posto   = $('#codigoPosto').val();
        $.ajax({
            type: "POST",
            url: "http://eforms.esy.es/phonegap/cadastraComentario.php",
            //url: "http://localhost:8888/combustivel/www/php/cadastraComentario.php",
            data: {comentario: comentario, codigoUsuario: id_usuario, codigoPosto: id_posto},
            success: function (result) {
                if(result == '1'){
                    alert('comentario salvo com sucesso!');
                    $('#textareaComentario').val('');
                    verificaComentarios(id_posto);
                }else{          
                    alert('não foi possível comentar. '+result);                                  
                }
            },
            error: function () {
                alert('error');
            }
        })
    }
}
/* FIM COMENTA POSTO*/

/* FAVORITA POSTO*/
$('#btnFavoritar').on('click',function(e){
    e.preventDefault();
    if($(this).html() == "Favoritar"){
        gravaFavorito();
    }else{
        deletaFavorito();
    }
    //
    //exibeMensagem("Favorito","Posto adicionado com sucesso!",'','OK!');
    
});
function gravaFavorito(){
    var id_usuario = window.localStorage.getItem("codigo");
    var id_posto   = $('#codigoPosto').val();
    $.ajax({
        type: "POST",
        url: "http://eforms.esy.es/phonegap/cadastraFavorito.php",
        //url: "http://localhost:8888/combustivel/www/php/cadastraFavorito.php",
        data: {codigoUsuario: id_usuario, codigoPosto: id_posto},
        success: function (result) {
            if(result == '1'){
                alert('Posto adicionado aos Favoritos!');
                $('#btnFavoritar').html('Deleta Favorito');
            }else{          
                alert('Não foi possivel favoritar.');                                  
            }
        },
        error: function () {
            alert('error');
        }
    })
}
function verificaFavorito(){
    var id_usuario = window.localStorage.getItem("codigo");
    var id_posto   = $('#codigoPosto').val();
    $.ajax({
        type: "GET",
        url: "http://eforms.esy.es/phonegap/verificaFavorito.php",
        //url: "http://localhost:8888/combustivel/www/php/verificaFavorito.php",
        data: {codigoUsuario: id_usuario, codigoPosto: id_posto},
        success: function (result) {
            if(result == '1'){
                $('#btnFavoritar').html('Deleta Favorito');
            }
        },
        error: function () {
            alert('error');
        }
    })
}
function deletaFavorito(){
    var id_usuario = window.localStorage.getItem("codigo");
    var id_posto   = $('#codigoPosto').val();
    $.ajax({
        type: "POST",
        url: "http://eforms.esy.es/phonegap/deletaFavorito.php",
        //url: "http://localhost:8888/combustivel/www/php/deletaFavorito.php",
        data: {codigoUsuario: id_usuario, codigoPosto: id_posto},
        success: function (result) {
            if(result == '1'){
                $('#btnFavoritar').html('Favoritar');
            }else{          
                alert('ocorreu um erro.');
            }
        },
        error: function () {
            alert('error');
        }
    })
}


/* FIM FAVORITA POSTO*/




function exibeMensagem(titulo,textoMaior,textoMenor,botao){
    $('#tituloPopup').html(titulo);
    $('#textoMaiorPopup').html(textoMaior);
    $('#textoMenorPopup').html(textoMenor);
    $('#btnOkPopup').html(botao);
    //$('#btnPopup').click();
}



/* INICIA PAGINA*/
$.fn.raty.defaults.path = 'raty/lib/images';
$(function() {

/* VALIDA E CARREGA PAGINA*/
var id = window.location.href.split("c=")[1];
if($.isNumeric(id)){
    buscarValoresPosto(id);
    verificaComentarios(id);
}else{
    window.document.href = "home.html";
}

/* FIM VALIDA E CARREGA PAGINA*/

$('#estrelas').raty({
  cancelOff  : 'cancel-off.png',
  cancelOn   : 'cancel-on.png',
  path       : 'raty/demo/images',
  precision  : false,
  starHalf   : 'star-half.png',
  starOff    : 'star-off.png',
  starOn     : 'star-on.png',
  targetKeep : true,
  click: function(score, evt) {
    var posto_id   = $('#codigoPosto').val();
    $.post('http://eforms.esy.es/phonegap/cadastraVotacao.php', {posto_id:posto_id,votacao:score}, function html(retorno) {
    //$.post('http://localhost:8888/combustivel/www/php/cadastraVotacao.php', {posto_id:posto_id,votacao:score}, function html(retorno) {
        alert('Votação realizada com sucesso!\nObrigado por sua ajuda.')
        media = retorno;
        $('#estrelas').raty('score',media);
        $('#readOnly-function-run').click();
    });
  }
});
$('#score-function-run').on('click', function() {
  $('#estrelas').raty('score', $('#' + this.id.replace('-run', '')).val());
});

$('#readOnly-function-run').on('click', function() {
    var isReadOnly = $('#' + this.id.replace('-run', '')).val() === 'true';
  $('#estrelas').raty('readOnly', isReadOnly);
});

//$('#estrelas').raty();


/*
DEIXAR SETADO E BLOQUEADO.
$('#estrelas').raty({ readOnly: true, score: 3 });

DEIXAR SETADO EM 0 E BLOQUEADO.
$('div').raty({
  readOnly: function() {
    return 'true becomes readOnly' == 'true becomes readOnly';
  }
});

DEIXAR SETADO COM VALOR NAO REDONDO
$('div').raty({ score: 3.26 });

*/



});


function verificaComentarios(posto_id){
    $.get('http://eforms.esy.es/phonegap/existeComentarios.php', {id_posto:posto_id}, function html(retorno) {
    //$.get('http://localhost:8888/combustivel/www/php/existeComentarios.php', {id_posto:posto_id}, function html(retorno) {
        
        if(retorno == '1'){
            document.getElementById("btnTodosComentarios").style.display = 'block';
            $('#btnTodosComentarios').attr('href','comentarios.html?c='+posto_id);
        }else{
            document.getElementById("btnTodosComentarios").style.display = 'none';
        }
    });
}
/* BUSCA POSTO*/
function buscarValoresPosto(posto_id) {    
    $.get('http://eforms.esy.es/phonegap/getPosto.php', {posto_id:posto_id}, function html(json) {
    //$.get('http://localhost:8888/combustivel/www/php/getPosto.php', {posto_id:posto_id}, function html(json) {
        
        dados = jQuery.parseJSON(json);
        
        $('#codigoPosto').val(dados.codigo);
        $('#nome').html(dados.nome);
        $('#headerNomePosto').html('Posto '+ dados.nome);
        $('#inputGasolina').val(dados.gasolina);
        $('#inputAlcool').val(dados.alcool);
        $('#inputDiesel').val(dados.diesel);
        $('#inputGnv').val(dados.gnv);
        $('#imgBandeira').attr('src','img/'+dados.bandeira);
        $('#endereco').html(dados.endereco);
        $('#latlonPosto').val(dados.latitude + "," + dados.longitude);
        
        $('#score-function').val(dados.mediaVotacao);
        $('#score-function-run').click();
        
        verificaFavorito();
        
        // var lat = dados.latitude;
        // var lon = dados.longitude;
        // url = "https://maps.googleapis.com/maps/api/geocode/json?latlng="+lat+","+lon;
        
        // $.get(url, function html(json2) {
        //     var cont = 0;
        //     var numero = '';
        //     var rua = '';
        //     var bairro = '';
        //     $.each(json2, function(arrayID,results) {
        //          $.each(results, function(index,items) {                                        
        //             $.each(items, function(index2,items2) {
        //                 $.each(items2, function(index3,items3) {
        //                     $.each(items3, function(index4,items4) {
        //                         if(index4 == 'short_name' && cont == 0){ numero = items4; cont = 1;
        //                         }else if(index4 == 'short_name' && cont == 1){ rua = items4; cont = 2;
        //                         }else if(index4 == 'short_name' && cont == 2){ bairro = items4; cont = 3;
        //                             $('#endereco').html(rua + ", "+numero+ ", "+bairro+".");
        //                         }

        //                     });
        //                 });
        //                 // if(index2 == 'formatted_address' && cont == 0){
        //                 //     $('#endereco').html(items2);
        //                 //     cont = 1;
        //                 // }
        //              });   
        //         });
        //     });
            
        // });
    });  
}
/* FIM BUSCA POSTO*/

$(document).on( "click", ".show-page-loading-msg", function() {
    var $this = $(this),
        theme = $this.jqmData( "theme" ) || $.mobile.loader.prototype.options.theme,
        msgText = $this.jqmData( "msgtext" ) || $.mobile.loader.prototype.options.text,
        textVisible = $this.jqmData( "textvisible" ) || $.mobile.loader.prototype.options.textVisible,
        textonly = !!$this.jqmData( "textonly" );
        html = $this.jqmData( "html" ) || "";
    $.mobile.loading( "show", {
            text: msgText,
            textVisible: textVisible,
            theme: theme,
            textonly: textonly,
            html: html
    });
})
.on( "click", ".hide-page-loading-msg", function() {
    $.mobile.loading( "hide" );
});
</script>
</body>
</html>